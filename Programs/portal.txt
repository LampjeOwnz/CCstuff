-- Version Information
-- Portal Program
prgrVersion = "0.7"
m = peripheral.wrap("top")

function downloadAPI()
	print("Updating...")
	sleep(1)
 
	request = http.get("https://raw.github.com/LampjeOwnz/CCstuff/master/APIs/button.txt")
	data = request.readAll()
 
	if fs.exists("button") then
		fs.delete("button")
		file = fs.open("button", "w")
		file.write(data)
		file.close()
	else
		file = fs.open("button", "w")
		file.write(data)
		file.close()
	end
 
	print("Update complete.")
	sleep(1)
	term.clear()
	term.setCursorPos(1,1)
	print("Portal program started.")
end

function checkAPI()
	print("Checking for API")
	sleep(1)
	if fs.exists("button") then
		os.unloadAPI("button")
		os.loadAPI("button")
 
		clientVersion = button.version()
 
		versionRequest = http.get("https://raw.github.com/LampjeOwnz/CCstuff/master/APIs/APIversions.txt")
		versionRequest.readLine()
		line = versionRequest.readLine()
		serverVersion = line	
		
		if serverVersion == clientVersion then
			print("You have the newest version of the API.")
			sleep(1)
			term.clear()
			term.setCursorPos(1,1)
			print("Portal program started.")
		else
			print("Current version: "..clientVersion..".")
			print("Version: "..serverVersion.." is now available. \nWould you like to update?")
			print("Type in: Yes To Update the Button API.")
   
			input = read()
   
			if string.lower(input) == "yes" then
				downloadAPI()
			else
				print("Update canceled.")
				print("Try again.")
				sleep(2)
				checkAPI()
			end
		end
	else
		downloadAPI()
	end
end

checkAPI()

os.loadAPI("button")
button.setMon("top")

function Resetcable()
	rs.setBundledOutput("back", colors.white)
end

Resetcable()

function Resetmonitor()
	sleep(5)
	button.setState("Abutton", true)
	button.setState("Bbutton", true)
	button.setState("Cbutton", true)
	--button.setState("Dbutton", true)
	--button.setState("Ebutton", true)
	rs.setBundledOutput("back", colors.white)
	button.draw()
end

function take()
	`sleep(1)
	rs.setBundledOutput("back", colors.black)
	sleep(1)
	rs.setBundledOutput("back", 0)
end

-- Redstone functions
function redstone()
	astate = button.getState("Abutton")
	bstate = button.getState("Bbutton")
	cstate = button.getState("Cbutton")
	--dstate = button.getState("Dbutton")
	--estate = button.getState("Ebutton")
	if astate == false then
		rs.setBundledOutput("back", colors.orange)
		take()
	end
	if bstate == false then
		rs.setBundledOutput("back", colors.magenta)
		take()
	end
	if cstate == false then
		rs.setBundledOutput("back", colors.lightBlue)
		take()
	end
	--if dstate == false then
	--	rs.setBundledOutput("back", colors.white + colors.yellow)
	--end
	--if estate == false then
	--	rs.setBundledOutput("back", colors.white + colors.lime)
	--end
	Resetmonitor()
end	

-- Making the button for the monitor + executing state function.
function knoppen()
	-- A Button
	button.add("Abutton", "Nerther", "toggle", 2, 2, 11, 4, colors.red, colors.lime, colors.white, 
	function ()
		print("Left A touched")
		redstone()
		button.draw()
	end)
	button.setState("Abutton", true)
	
	-- B button
	button.add("Bbutton", "The End", "toggle", 2, 6, 10, 8, colors.lightGray, colors.lime, colors.white, 
	function ()
		print("Left B touched")
		redstone()
		button.draw()
	end)
	button.setState("Bbutton", true)
	
	-- C button
	button.add("Cbutton", "Mining Age", "toggle", 2, 10, 14, 12, colors.green, colors.lime, colors.white, 
	function ()
		print("Right A touched")
		redstone()
		button.draw()
	end)
	button.setState("Cbutton", true)
	
	-- D button
	--button.add("Dbutton", "Right B", "toggle", 2, 14, 10, 16, colors.red, colors.lime, colors.white, 
	--function ()
	--	print("Right B touched")
	--	redstone()
	--	button.draw()
	--end)
	--button.setState("Dbutton", true)
	
	-- AE button
	--button.add("Ebutton", "AE Portal", "toggle", 13, 2, 23, 4, colors.red, colors.lime, colors.white, 
	--function ()
	--	print("AE portal touched")
	--	redstone()
	--	button.draw()
	--end)
	--button.setState("Ebutton", true)

	button.draw()
end

knoppen()

while true do
	button.check()
end